     1                                 %line 1+1 step0_repl.asm
     2                                 [section .data]
     3                                 
     4                                  LF equ 10
     5                                  NULL equ 0
     6                                 
     7                                  SYS_READ equ 0
     8                                  SYS_WRITE equ 1
     9                                  SYS_EXIT equ 60
    10                                 
    11                                  STDIN equ 0
    12                                  STDOUT equ 1
    13                                  STDERR equ 2
    14                                 
    15                                  EXIT_SUCCESS equ 0
    16                                 
    17                                  BUFFERSIZE equ 100
    18                                 
    19 00000000 757365723E2000          prompt db "user> ", NULL
    20                                  promptLen equ $-prompt-1
    21                                 
    22 00000007 4572726F72206F6E20-     errorMsg db "Error on read: ", NULL
    23 00000007 726561643A2000     
    24                                  errorMsgLen equ $-prompt-1
    25                                 
    26                                 [section .bss]
    27                                 
    28 00000000 <gap>                   buffer resb BUFFERSIZE
    29                                 
    30                                 [section .text]
    31                                 
    32                                 [global _start]
    33                                 _start:
    34                                 
    35                                 
    36 00000000 48C7C001000000          mov rax, SYS_WRITE
    37 00000007 48C7C701000000          mov rdi, STDOUT
    38 0000000E 488D3425[00000000]      lea rsi, byte [prompt]
    39 00000016 48BA06000000000000-     mov rdx, promptLen
    40 00000016 00                 
    41 00000020 0F05                    syscall
    42                                 
    43                                 
    44 00000022 488D3C25[00000000]      lea rdi, byte [buffer]
    45 0000002A 48C7C664000000          mov rsi, BUFFERSIZE
    46 00000031 E85E000000              call readline
    47                                 
    48 00000036 4883F800                cmp rax, 0
    49 0000003A 7445                    je step0Done
    50                                 
    51                                 
    52 0000003C 4883F800                cmp rax, 0
    53 00000040 7C10                    jl step0ReadError
    54                                 
    55                                 
    56                                 
    57                                 
    58 00000042 488D3C25[00000000]      lea rdi, byte [buffer]
    59 0000004A 4889C6                  mov rsi, rax
    60 0000004D E8BA000000              call printline
    61                                 
    62 00000052 EBAA                    jmp _start
    63                                 
    64                                 step0ReadError:
    65                                 
    66 00000054 4889C3                  mov rbx, rax
    67                                 
    68 00000057 48C7C001000000          mov rax, SYS_WRITE
    69 0000005E 48C7C701000000          mov rdi, STDOUT
    70 00000065 488D3425[00000000]      lea rsi, byte [errorMsg]
    71 0000006D 48BA16000000000000-     mov rdx, errorMsgLen
    72 0000006D 00                 
    73                                 
    74                                 
    75                                 
    76                                 
    77 00000077 48C7C03C000000          mov rax, SYS_EXIT
    78 0000007E 4889DF                  mov rdi, rbx
    79 00000081 0F05                    syscall
    80                                 
    81                                 
    82                                 step0Done:
    83                                 
    84 00000083 48C7C03C000000          mov rax, SYS_EXIT
    85 0000008A 48C7C700000000          mov rdi, EXIT_SUCCESS
    86 00000091 0F05                    syscall
    87                                 
    88                                 
    89                                 
    90                                 
    91                                 
    92                                 
    93                                 
    94                                 [global read]
    95                                 read:
    96 00000093 E8FCFFFFFF              call readline
    97 00000098 C3                      ret
    98                                 
    99                                 
   100                                 
   101                                 
   102                                 
   103                                 [global readline]
   104                                 readline:
   105 00000099 55                      push rbp
   106 0000009A 4889E5                  mov rbp, rsp
   107 0000009D 4883EC01                sub rsp, 1
   108 000000A1 53                      push rbx
   109 000000A2 4154                    push r12
   110 000000A4 4155                    push r13
   111 000000A6 4156                    push r14
   112                                 
   113 000000A8 48C7C300000000          mov rbx, 0
   114                                 
   115 000000AF 4989FC                  mov r12, rdi
   116 000000B2 4989F5                  mov r13, rsi
   117 000000B5 49C7C600000000          mov r14, 0
   118                                 
   119                                 getSingleCharacter:
   120                                 
   121 000000BC 48C7C000000000          mov rax, SYS_READ
   122 000000C3 48C7C700000000          mov rdi, STDIN
   123 000000CA 488D75FF                lea rsi, byte [rbp - 1]
   124 000000CE 48C7C201000000          mov rdx, 1
   125 000000D5 0F05                    syscall
   126                                 
   127                                 
   128                                 
   129 000000D7 4883F800                cmp rax, 0
   130 000000DB 7E1E                    jle readlineGotError
   131                                 
   132                                 
   133 000000DD 448A75FF                mov r14b, byte [rbp -1]
   134                                 
   135                                 
   136 000000E1 4180FE0A                cmp r14b, LF
   137 000000E5 740F                    je readlineGotEndChar
   138                                 
   139                                 
   140                                 
   141 000000E7 4C39EB                  cmp rbx, r13
   142 000000EA 73CE                    jae getSingleCharacter
   143                                 
   144                                 
   145 000000EC 48FFC3                  inc rbx
   146 000000EF 45883424                mov byte [r12], r14b
   147                                 
   148                                 
   149 000000F3 49FFC4                  inc r12
   150 000000F6 EBC2                    jmp getSingleCharacter
   151                                 
   152                                 readlineGotEndChar:
   153 000000F8 4889D8                  mov rax, rbx
   154 000000FB EB00                    jmp readlineDone
   155                                 
   156                                 readlineGotError:
   157                                 
   158                                 
   159 000000FD EBFE                    jmp readlineDone
   160                                 
   161                                 readlineDone:
   162 000000FF 415E                    pop r14
   163 00000101 415D                    pop r13
   164 00000103 415C                    pop r12
   165 00000105 5B                      pop rbx
   166 00000106 4889EC                  mov rsp, rbp
   167 00000109 5D                      pop rbp
   168 0000010A C3                      ret
   169                                 
   170                                 
   171                                 
   172                                 [global eval]
   173                                 eval:
   174                                 
   175                                 
   176                                 
   177                                 [global print]
   178                                 print:
   179 0000010B E8FCFFFFFF              call printline
   180 00000110 C3                      ret
   181                                 
   182                                 
   183                                 
   184                                 
   185                                 
   186                                 [global printline]
   187                                 printline:
   188                                 
   189 00000111 55                      push rbp
   190 00000112 4889E5                  mov rbp, rsp
   191 00000115 4883EC01                sub rsp, 1
   192 00000119 53                      push rbx
   193 0000011A 4154                    push r12
   194 0000011C 4155                    push r13
   195                                 
   196 0000011E 4989FC                  mov r12, rdi
   197 00000121 4989F5                  mov r13, rsi
   198                                 
   199 00000124 C645FF0A                mov byte [rbp - 1], LF
   200                                 
   201                                 
   202 00000128 48C7C001000000          mov rax, SYS_WRITE
   203 0000012F 48C7C701000000          mov rdi, STDOUT
   204 00000136 4C89E6                  mov rsi, r12
   205 00000139 4C89EA                  mov rdx, r13
   206 0000013C 0F05                    syscall
   207                                 
   208                                 
   209 0000013E 4883F800                cmp rax, 0
   210 00000142 7C27                    jl printlineError
   211                                 
   212                                 
   213 00000144 4889C3                  mov rbx, rax
   214                                 
   215                                 
   216 00000147 48C7C001000000          mov rax, SYS_WRITE
   217 0000014E 48C7C701000000          mov rdi, STDOUT
   218 00000155 488D75FF                lea rsi, byte [rbp -1]
   219 00000159 48C7C201000000          mov rdx, 1
   220 00000160 0F05                    syscall
   221                                 
   222                                 
   223 00000162 4883F800                cmp rax, 0
   224 00000166 7C03                    jl printlineError
   225                                 
   226                                 
   227 00000168 4801D8                  add rax, rbx
   228 0000016B EB00                    jmp printlineDone
   229                                 
   230                                 printlineError:
   231                                 
   232 0000016D EBFE                    jmp printlineDone
   233                                 
   234                                 printlineDone:
   235                                 
   236 0000016F 415D                    pop r13
   237 00000171 415C                    pop r12
   238 00000173 5B                      pop rbx
   239 00000174 4889EC                  mov rsp, rbp
   240 00000177 5D                      pop rbp
   241 00000178 C3                      ret
   242                                 
